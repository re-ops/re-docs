<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Intro</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/re-docs/assets/css/0.styles.6ddbcd86.css" as="style"><link rel="preload" href="/re-docs/assets/js/app.7c3d0768.js" as="script"><link rel="preload" href="/re-docs/assets/js/12.52a50eb1.js" as="script"><link rel="prefetch" href="/re-docs/assets/js/10.2efe42ab.js"><link rel="prefetch" href="/re-docs/assets/js/11.03c2a7a7.js"><link rel="prefetch" href="/re-docs/assets/js/13.44b477ad.js"><link rel="prefetch" href="/re-docs/assets/js/2.173a0891.js"><link rel="prefetch" href="/re-docs/assets/js/3.9c3cd31e.js"><link rel="prefetch" href="/re-docs/assets/js/4.7a97483c.js"><link rel="prefetch" href="/re-docs/assets/js/5.289eadc6.js"><link rel="prefetch" href="/re-docs/assets/js/6.959027d7.js"><link rel="prefetch" href="/re-docs/assets/js/7.cfe3d87f.js"><link rel="prefetch" href="/re-docs/assets/js/8.876427d6.js"><link rel="prefetch" href="/re-docs/assets/js/9.cf0c530b.js">
    <link rel="stylesheet" href="/re-docs/assets/css/0.styles.6ddbcd86.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/re-docs/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>Basics</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/re-docs/" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/#motivation" class="sidebar-link">Motivation</a></li><li class="sidebar-sub-header"><a href="/re-docs/#why-clojure" class="sidebar-link">Why Clojure</a></li><li class="sidebar-sub-header"><a href="/re-docs/#abstractions" class="sidebar-link">Abstractions</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Setup</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/re-docs/setup/" class="sidebar-link">Intro</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/#prerequisites" class="sidebar-link">Prerequisites</a></li></ul></li><li><a href="/re-docs/setup/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/re-docs/setup/re-core.html" class="sidebar-link">Re-core</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#setup" class="sidebar-link">Setup</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#templates" class="sidebar-link">Templates</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#hypervisors" class="sidebar-link">Hypervisors</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#aws" class="sidebar-link">AWS</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#digitalocean" class="sidebar-link">Digitalocean</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#kvm" class="sidebar-link">KVM</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-core.html#lxc" class="sidebar-link">LXC</a></li></ul></li></ul></li><li><a href="/re-docs/setup/re-mote.html" class="sidebar-link">Re-mote</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/re-mote.html#setup" class="sidebar-link">Setup</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-mote.html#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-mote.html#ssh" class="sidebar-link">SSH</a></li></ul></li><li><a href="/re-docs/setup/re-gent.html" class="sidebar-link">Re-gent</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/re-gent.html#build" class="sidebar-link">Build</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-gent.html#deploy" class="sidebar-link">Deploy</a></li></ul></li><li><a href="/re-docs/setup/re-dock.html" class="sidebar-link">Re-dock</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/re-dock.html#run" class="sidebar-link">Run</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-dock.html#dashboards" class="sidebar-link">Dashboards</a></li></ul></li><li><a href="/re-docs/setup/re-pack.html" class="sidebar-link">Re-pack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/setup/re-pack.html#build" class="sidebar-link">Build</a></li><li class="sidebar-sub-header"><a href="/re-docs/setup/re-pack.html#deploy" class="sidebar-link">Deploy</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>Usage</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/re-docs/usage/" class="active sidebar-link">Intro</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/usage/#reloaded" class="sidebar-link">Reloaded</a></li><li class="sidebar-sub-header"><a href="/re-docs/usage/#re-core" class="sidebar-link">Re-core</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/usage/#presets" class="sidebar-link">Presets</a></li></ul></li><li class="sidebar-sub-header"><a href="/re-docs/usage/#re-mote" class="sidebar-link">Re-mote</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/usage/#functions" class="sidebar-link">Functions</a></li></ul></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Architecture</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/re-docs/architecture/" class="sidebar-link">Components</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/re-docs/architecture/#networking" class="sidebar-link">Networking</a></li><li class="sidebar-sub-header"><a href="/re-docs/architecture/#security" class="sidebar-link">Security</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="intro"><a href="#intro" aria-hidden="true" class="header-anchor">#</a> Intro</h1> <p>In this section we will cover the basic workflows when using Re-mote and Re-core, there are a clear convention to both and they follow similar principles:</p> <ul><li>Prefer the Use simple functions and protocols (also nice for auto completion and composability)</li> <li>Use Separate REPL instances for Re-mote and Re-core (tough Re-core uses Re-mote)</li> <li>Use an editor attached to each REPL and re eval changing code if possible</li> <li>When making large changes use the <a href="#reloaded">Reloaded</a> workflow</li></ul> <h2 id="reloaded"><a href="#reloaded" aria-hidden="true" class="header-anchor">#</a> Reloaded</h2> <p>One of the nicest things that the REPLs provides is immediate feedback, it is also a live environment that can change code on the fly without a lengthy restart.</p> <p>Each time we start our session we run:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ lein repl
<span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>go<span class="token punctuation">)</span>
nil
</code></pre></div><p>The go function is defined in dev/user.clj file, it starts up all of our components by running setup and start:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token comment">; Re-core setup and start functions</span>
<span class="token punctuation">(</span><span class="token keyword">defn</span> start-
   <span class="token string">&quot;Starts the current development system.&quot;</span>
   <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token punctuation">(</span>load-secrets <span class="token string">&quot;secrets&quot;</span> <span class="token string">&quot;/tmp/secrets.edn&quot;</span> <span class="token string">&quot;keys/secret.gpg&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span>conf/load-config<span class="token punctuation">)</span>
   <span class="token punctuation">(</span>setup-logging<span class="token punctuation">)</span>
   <span class="token punctuation">(</span>k/create-server-keys <span class="token string">&quot;.curve&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span>mount/start #<span class="token operator">'elastic</span> #<span class="token operator">'zero</span> #<span class="token operator">'queue</span> #<span class="token operator">'workers</span> #<span class="token operator">'riemann</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span>mote-es/initialize<span class="token punctuation">)</span>
   <span class="token punctuation">(</span>core-es/initialize<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> stop
   <span class="token string">&quot;Shuts down and destroys the current development system.&quot;</span>
   <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token punctuation">(</span>sc/halt!<span class="token punctuation">)</span>
   <span class="token punctuation">(</span>mount/stop<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p>stop components by running:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
</code></pre></div><p>resets runs both stop and start in once go:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>reset<span class="token punctuation">)</span>
</code></pre></div><p>An alternative to reset is refresh which reloads changed functions (and mount state):</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>refresh<span class="token punctuation">)</span> <span class="token comment">; or (refresh-all)</span>
</code></pre></div><p>Note:</p> <ul><li>When changing a single function its better to re-eval it.</li> <li>when changeing multiple functions use refresh/refresh-all.</li> <li>Reset when you want to reload everthing and have a clean system state.</li> <li>A compilation error can be fixed by running refresh (reset will not be available in that case).</li></ul> <h2 id="re-core"><a href="#re-core" aria-hidden="true" class="header-anchor">#</a> Re-core</h2> <p>Re-core enables us create and manage systems (VMs, physical hosts, containers) by using a fluent functional interface and presets like instance size, volumes and types:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token comment">; create 5 c1-medium lxc instances using local node and defaults (user domain and os) using basic provisioning type</span>
<span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>create lxc local defaults <span class="token number">c1</span>-medium <span class="token operator">:basic</span> <span class="token number">5</span><span class="token punctuation">)</span>

Running create summary:

  ✔ basic-<span class="token number">db1afab199</span>
  ✔ basic-<span class="token number">5024861c63</span>
  ✔ basic-<span class="token number">2a35a70112</span>
  ✔ basic-<span class="token number">5c4a9e91e4</span>
  ✔ basic-<span class="token number">03df18b640</span>

</code></pre></div><p>Once we have instances running we can list them:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span><span class="token keyword">list</span><span class="token punctuation">)</span>

id                    hostname          type    os               hypervisor  ip          
-----------------------------------------------------------------------------------------
_-1Y9moBhnW7y7Uhb5JD  basic-<span class="token number">db1afab199</span>  <span class="token operator">:basic</span>  <span class="token operator">:ubuntu-18</span>.<span class="token number">04</span>.<span class="token number">2</span>  <span class="token operator">:lxc</span>        <span class="token number">10</span>.<span class="token number">63</span>.<span class="token number">95</span>.<span class="token number">159</span>
_u1Y9moBhnW7y7UhbpLo  basic-<span class="token number">5024861c63</span>  <span class="token operator">:basic</span>  <span class="token operator">:ubuntu-18</span>.<span class="token number">04</span>.<span class="token number">2</span>  <span class="token operator">:lxc</span>        <span class="token number">10</span>.<span class="token number">63</span>.<span class="token number">95</span>.<span class="token number">50</span> 
AO1Y9moBhnW7y7Uhb5Nm  basic-<span class="token number">2a35a70112</span>  <span class="token operator">:basic</span>  <span class="token operator">:ubuntu-18</span>.<span class="token number">04</span>.<span class="token number">2</span>  <span class="token operator">:lxc</span>        <span class="token number">10</span>.<span class="token number">63</span>.<span class="token number">95</span>.<span class="token number">102</span>
Ae1Y9moBhnW7y7Uhb5OE  basic-<span class="token number">5c4a9e91e4</span>  <span class="token operator">:basic</span>  <span class="token operator">:ubuntu-18</span>.<span class="token number">04</span>.<span class="token number">2</span>  <span class="token operator">:lxc</span>        <span class="token number">10</span>.<span class="token number">63</span>.<span class="token number">95</span>.<span class="token number">155</span>
Au1Y9moBhnW7y7Uhb5Ob  basic-<span class="token number">03df18b640</span>  <span class="token operator">:basic</span>  <span class="token operator">:ubuntu-18</span>.<span class="token number">04</span>.<span class="token number">2</span>  <span class="token operator">:lxc</span>        <span class="token number">10</span>.<span class="token number">63</span>.<span class="token number">95</span>.<span class="token number">30</span> 

</code></pre></div><p>Note: the first column contains unique auto generated ids (the elasticsearch system document id) that we can use to directly reference an instance.</p> <p>The main workflows on systems (in Re-core lingo) are found under src/re_core/repl.clj, we can operate on all running instances by running:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>halt<span class="token punctuation">)</span>
#&lt;Future@<span class="token number">319b7be4</span> pending&gt;

<span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ:

Running halt summary:

  ✔ basic-<span class="token number">db1afab199</span>
  ✔ basic-<span class="token number">5024861c63</span>
  ✔ basic-<span class="token number">2a35a70112</span>
  ✔ basic-<span class="token number">5c4a9e91e4</span>
  ✔ basic-<span class="token number">03df18b640</span>

<span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>start<span class="token punctuation">)</span>
#&lt;Future@<span class="token number">36feaf62</span> pending&gt;

<span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ:

Running start summary:

  ✔ basic-<span class="token number">db1afab199</span>
  ✔ basic-<span class="token number">5024861c63</span>
  ✔ basic-<span class="token number">5c4a9e91e4</span>
  ✔ basic-<span class="token number">2a35a70112</span>
  ✔ basic-<span class="token number">03df18b640</span>

</code></pre></div><p>All workflows take a filtering function, making it real easy to select the instances we operate on:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>halt <span class="token punctuation">(</span>by-type <span class="token operator">:basic</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  ✔ basic-<span class="token number">db1afab199</span>
  ✔ basic-<span class="token number">5024861c63</span>
  ✔ basic-<span class="token number">5c4a9e91e4</span>
  ✔ basic-<span class="token number">2a35a70112</span>
  ✔ basic-<span class="token number">03df18b640</span>

Running halt summary:

<span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>start <span class="token punctuation">(</span>matching <span class="token string">&quot;5Nm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">; select instance by partial id matching (ala git style)</span>

Running halt summary:

  ✔ basic-<span class="token number">2a35a70112</span>

</code></pre></div><p>Note:</p> <ul><li>The default filtering function is ip which selects all the running instances (assumed to have an active ip addresset).</li> <li>Check Re-core <a href="https://re-ops.github.io/re-core" target="_blank" rel="noopener noreferrer">API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for a detailed list of the available functions.</li></ul> <h3 id="presets"><a href="#presets" aria-hidden="true" class="header-anchor">#</a> Presets</h3> <p>Presets are functions that are used to speed up the creation process of new systems, they do that by reducing the boilerplate we have to type and by being easy to memorize, when we use the create function we pass in a number of preset functions that create the system structure for us:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-core<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>create lxc local defaults <span class="token number">c1</span>-medium <span class="token operator">:basic</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre></div><p>The lxc var holds an empty system stub:</p> <div class="language- extra-class"><pre class="language-text"><code>(def lxc {:lxc {} :machine {}})

</code></pre></div><p>Each preset function adds in more information to our stub for example local sets the system node to be localhost for both KVM and LXC instances:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defn</span> <span class="token keyword">node</span> <span class="token punctuation">[</span>n<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token punctuation">(</span>assoc-in instance <span class="token punctuation">[</span><span class="token punctuation">(</span>figure-virt instance<span class="token punctuation">)</span> <span class="token operator">:node</span><span class="token punctuation">]</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">def</span> local <span class="token punctuation">(</span><span class="token keyword">node</span> <span class="token operator">:localhost</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p>Last is c1-medium which is a member of a generated list of functions in the re-core.presets.instance-types namespace, these functions represents a collection of possible RAM and CPU size combinations (matching similar machine types in AWS):</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">def</span> simple <span class="token punctuation">{</span><span class="token operator">:tiny</span> <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">1</span> <span class="token operator">:ram</span> <span class="token number">0</span>.<span class="token number">5</span><span class="token punctuation">}</span>
               <span class="token operator">:small</span> <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">2</span> <span class="token operator">:ram</span> <span class="token number">1</span><span class="token punctuation">}</span>
               <span class="token operator">:large</span> <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">4</span> <span class="token operator">:ram</span> <span class="token number">4</span><span class="token punctuation">}</span>
               <span class="token operator">:xlarge</span> <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">8</span> <span class="token operator">:ram</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">; based on https://github.com/dustinkirkland/instance-type/blob/master/yaml/aws.yaml</span>
  <span class="token punctuation">(</span><span class="token keyword">def</span> aws <span class="token punctuation">{</span><span class="token operator">:c1-medium</span> <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">2</span> <span class="token operator">:ram</span> <span class="token number">1</span>.<span class="token number">7</span><span class="token punctuation">}</span>
            <span class="token operator">:c1-xlarge</span>  <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">8</span> <span class="token operator">:ram</span> <span class="token number">7</span><span class="token punctuation">}</span>
            <span class="token operator">:c3-2xlarge</span>  <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">8</span> <span class="token operator">:ram</span> <span class="token number">15</span><span class="token punctuation">}</span>
            <span class="token operator">:c3-4xlarge</span>  <span class="token punctuation">{</span><span class="token operator">:cpu</span> <span class="token number">16</span> <span class="token operator">:ram</span> <span class="token number">30</span><span class="token punctuation">}</span>
            <span class="token keyword">..</span>.
            <span class="token punctuation">)</span>

</code></pre></div><p>For more please check the matching re-core <a href="https://re-ops.github.io/re-core/re-core.presets.common.html" target="_blank" rel="noopener noreferrer">docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> section and the <a href="https://github.com/re-ops/re-core/tree/master/src/re_core/presets" target="_blank" rel="noopener noreferrer">source code<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="re-mote"><a href="#re-mote" aria-hidden="true" class="header-anchor">#</a> Re-mote</h2> <p>One of Re-mote main abstraction is the Hosts type:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">def</span> sandbox <span class="token punctuation">(</span>Hosts. <span class="token punctuation">{</span><span class="token operator">:user</span> <span class="token string">&quot;re-ops&quot;</span> <span class="token operator">:ssh-key</span> <span class="token string">&quot;/home/foo/.ssh/id_rsa} [&quot;</span><span class="token number">192</span>.<span class="token number">168</span>.<span class="token number">2</span>.<span class="token number">28</span><span class="token string">&quot; &quot;</span><span class="token number">192</span>.<span class="token number">168</span>.<span class="token number">2</span>.<span class="token number">27</span>&quot;<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>It includes an authentication map (user and ssh key) and a list of hosts, protocols with different operations extend the Hosts type:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token comment">; re-mote.repl.base</span>
<span class="token punctuation">(</span><span class="token keyword">defrecord</span> Hosts <span class="token punctuation">[</span>auth hosts<span class="token punctuation">]</span>
  Shell
  <span class="token punctuation">(</span>ls <span class="token punctuation">[</span>this target flags<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>this <span class="token punctuation">(</span>run-hosts this <span class="token punctuation">(</span>script <span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span> ~target ~flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Bundled operations range from package management to ZFS operations like scrub and even nmap port scanning.</p> <p>Operations are used within pipelines:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">defn</span> listing <span class="token punctuation">[</span>hs<span class="token punctuation">]</span>
  <span class="token punctuation">(</span>run <span class="token punctuation">(</span>ls hs <span class="token string">&quot;/&quot;</span> <span class="token string">&quot;-la&quot;</span><span class="token punctuation">)</span> | <span class="token punctuation">(</span>pretty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Running a workflow is simple as calling a function:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">[</span>re-mote<span class="token punctuation">]</span>λ: <span class="token punctuation">(</span>listing sandbox<span class="token punctuation">)</span>

Run summary:

   ✔ <span class="token number">192</span>.<span class="token number">168</span>.<span class="token number">2</span>.<span class="token number">28</span>
   ✔ <span class="token number">192</span>.<span class="token number">168</span>.<span class="token number">2</span>.<span class="token number">27</span>
   ✔ <span class="token number">192</span>.<span class="token number">168</span>.<span class="token number">2</span>.<span class="token number">26</span>

</code></pre></div><p>For a complete listing of workflows check Re-mote <a href="https://re-ops.github.io/re-mote" target="_blank" rel="noopener noreferrer">API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> documentation.</p> <h3 id="functions"><a href="#functions" aria-hidden="true" class="header-anchor">#</a> Functions</h3> <p>Re-mote can invoke distributed Clojure functions using Re-gent processes across the cluster, the functions are defined under re_mote/zero/functions.clj:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">ns</span> re-mote.zero.functions
  <span class="token punctuation">(</span><span class="token operator">:require</span>
   <span class="token punctuation">[</span>clojure.java.shell <span class="token operator">:refer</span> <span class="token punctuation">[</span>sh<span class="token punctuation">]</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>serializable.<span class="token keyword">fn</span> <span class="token operator">:as</span> s<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>me.raynes.fs <span class="token operator">:refer</span> <span class="token punctuation">(</span>list-dir tmpdir exists? file<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">; Package manager</span>
<span class="token punctuation">(</span><span class="token keyword">def</span> ^<span class="token punctuation">{</span><span class="token operator">:doc</span> <span class="token string">&quot;update package manager&quot;</span><span class="token punctuation">}</span> pkg-update
  <span class="token punctuation">(</span>s/<span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span>case <span class="token punctuation">(</span>os<span class="token punctuation">)</span>
      <span class="token operator">:Ubuntu</span> <span class="token punctuation">(</span>sh <span class="token string">&quot;sudo&quot;</span> <span class="token string">&quot;apt&quot;</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">)</span>
      <span class="token operator">:FreeBSD</span> <span class="token punctuation">(</span>sh <span class="token string">&quot;sudo&quot;</span> <span class="token string">&quot;pkg&quot;</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">throw</span> <span class="token punctuation">(</span>ex-info <span class="token string">&quot;not supported&quot;</span> <span class="token punctuation">{</span><span class="token operator">:os</span> <span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Functions may use any bundled Clojure and Java libraries like:</p> <ul><li>me.raynes.fs for file system manipulation</li> <li>com.github.oshi for collecting OS/Hardware information</li> <li>re-scan for running Nmap scans</li></ul> <p>Adding new libraries is pretty simple:</p> <ul><li>Add the library to both re-gent/project.clj and re-mote/project.clj.</li> <li>Import the required ns/classes into re-mote.zero.functions and re-gent.zero.functions</li> <li>Build the re-gent binary using bin/binary.sh</li> <li>Deploy re-gent to the machines using the deploy workflow</li></ul> <h1 id="scheduling"><a href="#scheduling" aria-hidden="true" class="header-anchor">#</a> Scheduling</h1> <p>Invoking tasks in the REPL is easy but in some cases we would like to set a task to be executed at repeated short intervals (like collecting metrics):</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token comment">; collecting RAM, Network, Load anc Cpu usage</span>
<span class="token punctuation">(</span><span class="token keyword">defn</span> stats-jobs <span class="token punctuation">[</span>hs<span class="token punctuation">]</span>
  <span class="token punctuation">(</span>watch <span class="token operator">:ram</span> <span class="token punctuation">(</span>seconds <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>ram-persist hs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>watch <span class="token operator">:net</span> <span class="token punctuation">(</span>seconds <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>net-persist hs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>watch <span class="token operator">:cpu</span> <span class="token punctuation">(</span>seconds <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>cpu-persist hs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>watch <span class="token operator">:load</span> <span class="token punctuation">(</span>seconds <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>load-persist hs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Another use case is executing long running tasks once a day:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token comment">; running apt uprgrade on hosts every day at 4AM</span>
<span class="token punctuation">(</span><span class="token keyword">defn</span> apt-jobs <span class="token punctuation">[</span>hosts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span>watch <span class="token operator">:upgrade</span> <span class="token punctuation">(</span>every-day <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>upgrade hosts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p>Or even once a week:</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token comment">; Running zfs scrub every Saturday at 4AM</span>
<span class="token punctuation">(</span><span class="token keyword">defn</span> zfs-maintain <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token operator">:keys</span> <span class="token punctuation">[</span>hosts<span class="token punctuation">]</span> <span class="token operator">:as</span> hs<span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>host <span class="token punctuation">(</span><span class="token keyword">first</span> hosts<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span>watch <span class="token punctuation">(</span><span class="token keyword">keyword</span> <span class="token punctuation">(</span><span class="token keyword">str</span> host <span class="token string">&quot;-datastore-scrub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>at-day DateTimeConstants/SATURDAY <span class="token number">4</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>run <span class="token punctuation">(</span>scrub hs <span class="token string">&quot;datastore&quot;</span><span class="token punctuation">)</span> | <span class="token punctuation">(</span>email <span class="token punctuation">(</span>tofrom <span class="token punctuation">(</span><span class="token keyword">&lt;</span>&lt; <span class="token string">&quot;scrubing ~{host}/datastore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Its possible to automate any function call using the watch function including the creation of VMs or provisioning, check Re-share <a href="https://re-ops.github.io/re-share" target="_blank" rel="noopener noreferrer">docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for full API documentation.</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/re-docs/setup/re-pack.html" class="prev">
          Re-pack
        </a></span> <span class="next"><a href="/re-docs/architecture/">
          Components
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/re-docs/assets/js/app.7c3d0768.js" defer></script><script src="/re-docs/assets/js/12.52a50eb1.js" defer></script>
  </body>
</html>
